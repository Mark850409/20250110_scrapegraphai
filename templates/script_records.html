{% extends "base.html" %}

{% block title %}腳本生成紀錄 - AI大語言模型爬蟲工具{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>腳本生成紀錄</h2>
        <button id="clearRecordsBtn" class="btn btn-danger" style="display: none;">
            <i class="fas fa-trash-alt me-2"></i>清除所有紀錄
        </button>
    </div>

    <!-- 說明卡片 -->
    <div class="card mb-4 bg-light">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>關於腳本生成紀錄</h5>
            <p class="card-text mb-0">
                在這裡，您可以查看所有已生成的爬蟲腳本紀錄。每個紀錄包含：
            </p>
            <ul class="mb-0 mt-2">
                <li>生成時間 - 腳本產生的確切時間</li>
                <li>目標網址 - 爬蟲的目標網站</li>
                <li>使用的提示詞 - 用於生成腳本的提示</li>
                <li>處理時間 - 腳本生成所需時間</li>
            </ul>
        </div>
    </div>
    
    <!-- 無紀錄時的提示 -->
    <div id="noRecordsMsg" class="text-center py-5" style="display: none;">
        <div class="empty-state">
            <i class="fas fa-clipboard-list fa-4x mb-3 text-muted"></i>
            <h4 class="text-muted">目前沒有腳本生成紀錄</h4>
            <p class="text-muted mb-4">當您生成新的爬蟲腳本時，紀錄將會顯示在這裡</p>
            <a href="/script-generation" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>生成新腳本
            </a>
        </div>
    </div>

    <!-- 紀錄表格 -->
    <div id="recordsTable" class="card" style="display: none;">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="px-4">生成時間</th>
                            <th>網址</th>
                            <th>提示詞</th>
                            <th class="text-center">耗時</th>
                            <th class="text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordsList">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 載入中提示 -->
<div id="loadingIndicator" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-2 text-muted">載入紀錄中...</p>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadRecords();

    document.getElementById('clearRecordsBtn').addEventListener('click', function() {
        Swal.fire({
            title: '確定要清除所有紀錄？',
            text: "此操作無法復原！",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '是的，清除',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                clearRecords();
            }
        });
    });
});

function loadRecords() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noRecordsMsg = document.getElementById('noRecordsMsg');
    const recordsTable = document.getElementById('recordsTable');
    const clearBtn = document.getElementById('clearRecordsBtn');

    // 顯示載入中提示
    loadingIndicator.style.display = 'block';
    noRecordsMsg.style.display = 'none';
    recordsTable.style.display = 'none';
    clearBtn.style.display = 'none';

    fetch('/api/script-records')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            loadingIndicator.style.display = 'none';
            
            if (!data.records || data.records.length === 0) {
                noRecordsMsg.style.display = 'block';
                recordsTable.style.display = 'none';
                clearBtn.style.display = 'none';
                return;
            }

            noRecordsMsg.style.display = 'none';
            recordsTable.style.display = 'block';
            clearBtn.style.display = 'block';
            
            const tableBody = document.getElementById('recordsList');
            tableBody.innerHTML = data.records.map(record => {
                // 解码脚本内容
                const decodedScript = decodeURIComponent(record.script);
                return `
                    <tr>
                        <td class="px-4">${formatDate(record.timestamp)}</td>
                        <td class="text-truncate" style="max-width: 200px;">
                            <a href="${record.url}" target="_blank" title="${record.url}">
                                ${record.url}
                            </a>
                        </td>
                        <td class="text-truncate" style="max-width: 200px;" title="${record.prompt}">
                            ${record.prompt}
                        </td>
                        <td class="text-center">${record.duration}秒</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-primary" onclick="viewScript({ 
                                timestamp: '${record.timestamp}', 
                                url: '${record.url}', 
                                prompt: '${record.prompt}', 
                                duration: '${record.duration}', 
                                script: '${encodeURIComponent(decodedScript)}' 
                            })">
                                <i class="fas fa-code me-1"></i>查看腳本
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Error:', error);
            loadingIndicator.style.display = 'none';
            noRecordsMsg.style.display = 'block';
            recordsTable.style.display = 'none';
            clearBtn.style.display = 'none';
            
            Swal.fire({
                title: '錯誤',
                text: '載入記錄時發生錯誤',
                icon: 'error',
                confirmButtonText: '確定'
            });
        });
}

// 更新格式化日期函数以确保一致性
function formatDate(timestamp) {
    if (!timestamp) return '未提供';
    try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return timestamp; // 如果转换失败，返回原始值
        
        return date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    } catch (e) {
        console.error('Date formatting error:', e);
        return timestamp;
    }
}

function clearRecords() {
    fetch('/api/script-records', {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('清除記錄失敗');
        }
        return response.json();
    })
    .then(data => {
        loadRecords();
        Swal.fire({
            title: '已清除',
            text: data.message || '所有記錄已成功清除',
            icon: 'success',
            confirmButtonText: '確定'
        });
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: '錯誤',
            text: '清除記錄時發生錯誤',
            icon: 'error',
            confirmButtonText: '確定'
        });
    });
}

function viewScript(record) {
    // 对脚本内容进行解码，以便在 HTML 中显示原始内容
    const decodedScript = decodeURIComponent(record.script);
    
    // 使用 SweetAlert 显示脚本内容
    Swal.fire({
        title: '腳本內容', // 弹窗标题
        html: `
            <div class="accordion" id="scriptAccordion">
                <!-- 折叠菜单：脚本相关信息 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingInfo">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInfo" aria-expanded="true" aria-controls="collapseInfo">
                            腳本相關資訊
                        </button>
                    </h2>
                    <div id="collapseInfo" class="accordion-collapse collapse show" aria-labelledby="headingInfo" data-bs-parent="#scriptAccordion">
                        <div class="accordion-body">
                            <p><strong>生成時間:</strong> ${record.timestamp || '未提供'}</p>
                            <p><strong>網址:</strong> <a href="${record.url || '#'}" target="_blank">${record.url || '未提供'}</a></p>
                            <p><strong>提示詞:</strong> ${record.prompt || '未提供'}</p>
                            <p><strong>耗時:</strong> ${record.duration || '未提供'}秒</p>
                        </div>
                    </div>
                </div>

                <!-- 折叠菜单：脚本代码 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingCode">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCode" aria-expanded="false" aria-controls="collapseCode">
                            腳本程式碼
                        </button>
                    </h2>
                    <div id="collapseCode" class="accordion-collapse collapse" aria-labelledby="headingCode" data-bs-parent="#scriptAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-sm btn-outline-primary mb-2" onclick="copyScript('${encodeURIComponent(decodedScript)}')">
                                <i class="fas fa-copy"></i> 複製程式碼
                            </button>
                            <pre class="text-start" style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px;">
                                <code class="language-python">${decodedScript}</code>
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        `,
        width: '80%', // 弹窗宽度
        confirmButtonText: '關閉', // 确认按钮文本
        showCloseButton: true, // 显示关闭按钮
        customClass: {
            popup: 'swal-wide', // 自定义弹窗样式
            content: 'text-start' // 内容左对齐
        },
        didOpen: () => {
            // 在弹窗打开后高亮代码
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }
    });
}

function copyScript(script) {
    navigator.clipboard.writeText(decodeURIComponent(script)).then(() => {
        const copyBtn = document.querySelector('.swal2-container .btn-outline-primary');
        copyBtn.innerHTML = '<i class="fas fa-check"></i> 已複製';
        copyBtn.classList.remove('btn-outline-primary');
        copyBtn.classList.add('btn-success');
        setTimeout(() => {
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> 複製程式碼';
            copyBtn.classList.remove('btn-success');
            copyBtn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(err => {
        console.error('複製失敗:', err);
        Swal.fire({
            title: '複製失敗',
            text: '請手動複製程式碼',
            icon: 'error',
            confirmButtonText: '確定'
        });
    });
}
</script>

<style>
.empty-state {
    padding: 2rem;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.swal-wide {
    max-width: 800px !important;
}

.table td {
    vertical-align: middle;
}

.table th {
    font-weight: 600;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}
</style>
{% endblock %}
{% endblock %}
